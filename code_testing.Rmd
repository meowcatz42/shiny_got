---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 
```{r}

```

```{r}
library(readr)
characters = read_csv("data/characters.csv")
episodes = read_csv("data/episodes.csv")
scenes = read_csv("data/scenes.csv")
appearances = read_csv("data/appearances.csv")
```
```{r}
library(sf)
library(tidyr)
library(ggplot2)
locations=st_read("./data/GoTRelease/Locations.shp",crs=4326)
```


```{r}
lakes=st_read("./data/GoTRelease/Lakes.shp",crs=4326)
conts=st_read("./data/GoTRelease/Continents.shp",crs=4326)
land=st_read("./data/GoTRelease/Land.shp",crs=4326)
wall=st_read("./data/GoTRelease/Wall.shp",crs=4326)
islands=st_read("./data/GoTRelease/Islands.shp",crs=4326)
kingdoms=st_read("./data/GoTRelease/Political.shp",crs=4326)
landscapes=st_read("./data/GoTRelease/Landscape.shp",crs=4326)
roads=st_read("./data/GoTRelease/Roads.shp",crs=4326)
rivers=st_read("./data/GoTRelease/Rivers.shp",crs=4326)

```
```{r}
colforest="#29b524"
colriver="#4f79f0"
collake="#87cdde"
colland="ivory"
borderland = "ivory3"  
ggplot()+geom_sf(data=land,fill=colland,col=borderland,size=0.1)+
  geom_sf(data=islands,fill=colland,col="ivory3")+
  geom_sf(data=landscapes %>% filter(type=="forest"),fill=colforest,col=colforest)+
  geom_sf(data=rivers,col=colriver)+
  geom_sf(data=lakes,col=collake,fill=collake)+
  geom_sf(data=wall,col="black",size=1)+
  geom_sf_text(data= locations %>% filter(size>4,name!='Tolos'),aes(label=name),size=2.5,family="Palatino", fontface="italic")+
  theme_minimal()+coord_sf(expand = 0,ndiscr = 0)+
  theme(panel.background = element_rect(fill = colriver,color=NA)) +
  labs(title = "Royaumes de GOT",caption = "Distribution des ",x="",y="")
```

```{r}
scenes_locations=st_read("./data/GoTRelease/ScenesLocations.shp",crs=4326)
main_char= c("Jon Snow", "Tyrion Lannister","Daenerys Targaryen","Sansa Stark","Cersei Lannister","Arya Stark")
landpol = st_union(st_geometry(land)) 
islandpol = st_union(st_geometry(islands))
backpol=st_union(landpol,islandpol)
background = st_as_sf(data.frame(name=main_char,geometry=rep(backpol,6)))
loc_time=appearances %>% filter(name %in% main_char) %>% left_join(scenes) %>% group_by(location,name) %>% summarize(duration=sum(duration,na.rm=TRUE)) 
loc_time_mc = scenes_locations %>% left_join(loc_time)
char_name = 'Jon Snow'
if (char_name == 'Jon Snow')
  {
    ggplot()+geom_sf(data=background,color=borderland,fill=colland)+
  geom_sf(data=loc_time_mc%>% filter(!is.na(duration))%>%filter(name==char_name),aes(size=duration/60,color=name))+
  geom_sf_text(data=loc_time_mc%>% filter(duration>60*60),aes(label=location),color="#000000",vjust="bottom",family="Palatino", fontface="italic")+
  coord_sf(expand = 0,ndiscr = 0)+
  scale_color_discrete(guide="none")+
  scale_size_area("Durée (min) :",max_size = 12,breaks=c(30,60,120,240))+
  #facet_wrap(~name)+
  theme(panel.background = element_rect(fill = colriver,color=NA),
        text = element_text(family="Palatino",face = "bold",size = 14),
        legend.key = element_rect(fill="#ffffff"),
        ) +
  labs(title = paste("Répartition spatiale des scènes de", char_name, sep=" "),caption = "@comeetie, 2020",x="",y="")
  }
  

```

```{r}
ggplot()+geom_sf(data=background,color=borderland,fill=colland)+
  geom_sf(data=loc_time_mc%>% filter(!is.na(duration)),aes(size=duration/60,color=name))+
  geom_sf_text(data=loc_time_mc%>% filter(duration>60*60),aes(label=location),color="#000000",vjust="bottom",family="Palatino", fontface="italic")+
  coord_sf(expand = 0,ndiscr = 0)+
  scale_color_discrete(guide="none")+
  scale_size_area("Durée (min) :",max_size = 12,breaks=c(30,60,120,240))+
  facet_wrap(~name)+
  theme(panel.background = element_rect(fill = colriver,color=NA),
        text = element_text(family="Palatino",face = "bold",size = 14),
        legend.key = element_rect(fill="#ffffff"),
        ) +
  labs(title = "Temps de présence des personnage principaux",caption = "@comeetie, 2020",x="",y="")
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
